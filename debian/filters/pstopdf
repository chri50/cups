#!/bin/sh

# $Id: pstopdf,v 1.3 2003/02/15 15:21:00 gurubert Exp $
#
# This is a Postscript to PDF filter for CUPS
#
# (C) 2003 Robert Sander <robert.sander@epigenomics.com>
#
# Released under GPL
#
# NO WARRANTY AT ALL
#

set -e

PSTOPS=/usr/bin/ps2ps
PSTOPDF=/usr/bin/ps2pdf13
PSTOPS_OPTIONS="-dAutoRotatePages=/None -dAutoFilterColorImages=false
                -dNOPLATFONTS -dPARANOIDSAFER -sstdout=%stderr"
PSTOPDF_OPTIONS="$PSTOPS_OPTIONS -dColorImageFilter=/FlateEncode"

echo "INFO: pstopdf argv[$#] = $@" >&2

if [ $# -lt 5 -o $# -gt 6 ]; then

  echo "ERROR: $0 job-id user title copies options [file]" >&2
  exit 1

fi

# Read from given file.
if [ -n "$6" ]; then
  exec <"$6"
fi

tempfiles=
trap 'rm -f $tempfiles' 0 1 2 13 15

infile=$(mktemp -t pstopdf.XXXXXX)
tempfiles="$tempfiles $infile"

cat >"$infile"

DRM_MATCH='^%.*Removing the following.*lines is illegal.*Digital Copyright Act'
if egrep -q "$DRM_MATCH" "$infile"; then
  # This PS is DRM-infested. Normalize it with ps2ps first.
  echo "INFO: Normalizing Adobe Reader PostScript with ps2ps" >&2

  orig_infile="$infile"

  infile=$(mktemp -t pstopdf.XXXXXX)
  tempfiles="$tempfiles $infile"

  $PSTOPS $PSTOPS_OPTIONS "$orig_infile" "$infile"
fi

$PSTOPDF $PSTOPDF_OPTIONS -sOUTPUTFILE=%stdout "$infile"


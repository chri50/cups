#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2008-5286.dpatch by Marc Deslauriers <marc.deslauriers@ubuntu.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: fix arbitrary code execution via integer overflow from a PNG
## DP: image with a large height value
## Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=507183
## Upstream: http://www.cups.org/str.php?L2974
## Patch: http://www.cups.org/strfiles/2974/str2974.patch

@DPATCH@
diff -urNad cups-1.3.9~/filter/image-png.c cups-1.3.9/filter/image-png.c
--- cups-1.3.9~/filter/image-png.c	2008-07-11 18:48:49.000000000 -0400
+++ cups-1.3.9/filter/image-png.c	2009-01-08 08:27:47.000000000 -0500
@@ -178,7 +178,7 @@
     {
       bufsize = img->xsize * img->ysize;
 
-      if ((bufsize / img->ysize) != img->xsize)
+      if ((bufsize / img->xsize) != img->ysize)
       {
 	fprintf(stderr, "DEBUG: PNG image dimensions (%ux%u) too large!\n",
 		(unsigned)width, (unsigned)height);
@@ -190,7 +190,7 @@
     {
       bufsize = img->xsize * img->ysize * 3;
 
-      if ((bufsize / (img->ysize * 3)) != img->xsize)
+      if ((bufsize / (img->xsize * 3)) != img->ysize)
       {
 	fprintf(stderr, "DEBUG: PNG image dimensions (%ux%u) too large!\n",
 		(unsigned)width, (unsigned)height);

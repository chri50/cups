#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix denial of service or arbitrary code execution in
#  texttops image filter
# From: David Remahl

@DPATCH@
diff -urNad cups-1.3.9~/filter/texttops.c cups-1.3.9/filter/texttops.c
--- cups-1.3.9~/filter/texttops.c	2008-10-09 16:12:03.000000000 -0400
+++ cups-1.3.9/filter/texttops.c	2010-06-15 09:41:54.000000000 -0400
@@ -181,8 +181,20 @@
     exit(1);
   }
 
-  Page    = calloc(sizeof(lchar_t *), SizeLines);
-  Page[0] = calloc(sizeof(lchar_t), SizeColumns * SizeLines);
+  if ((Page = calloc(sizeof(lchar_t *), SizeLines)) == NULL)
+  {
+    _cupsLangPrintf(stderr, _("ERROR: Unable to print %dx%d text page.\n"),
+                    SizeColumns, SizeLines);
+    exit(1);
+  }
+
+  if ((Page[0] = calloc(sizeof(lchar_t), SizeColumns * SizeLines)) == NULL)
+  {
+    _cupsLangPrintf(stderr, _("ERROR: Unable to print %dx%d text page.\n"),
+                    SizeColumns, SizeLines);
+    exit(1);
+  }
+
   for (i = 1; i < SizeLines; i ++)
     Page[i] = Page[0] + i * SizeColumns;
 

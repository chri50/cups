#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix buffer overflow in cupsRasterReadPixels
# Origin: upstream, http://marc.info/?l=cups-commit&m=131299081010932&w=2
# Origin: upstream, https://www.cups.org/strfiles.php/3438/str4551.patch
# Bug: https://www.cups.org/str.php?L4551
# Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=778387

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' cups-1.4.3~/filter/raster.c cups-1.4.3/filter/raster.c
--- cups-1.4.3~/filter/raster.c	2008-07-11 18:46:21.000000000 -0400
+++ cups-1.4.3/filter/raster.c	2015-02-25 13:45:05.169667803 -0500
@@ -239,7 +239,10 @@
   */
 
   if (!cups_raster_read_header(r))
+  {
+    memset(h, 0, sizeof(cups_page_header_t));
     return (0);
+  }
   
  /*
   * Copy the header to the user-supplied buffer...
@@ -268,7 +271,10 @@
   */
 
   if (!cups_raster_read_header(r))
+  {
+    memset(h, 0, sizeof(cups_page_header2_t));
     return (0);
+  }
   
  /*
   * Copy the header to the user-supplied buffer...
@@ -302,7 +308,8 @@
   int		count;			/* Repetition count */
 
 
-  if (r == NULL || r->mode != CUPS_RASTER_READ || r->remaining == 0)
+  if (r == NULL || r->mode != CUPS_RASTER_READ || r->remaining == 0 ||
+      r->header.cupsBytesPerLine == 0)
     return (0);
 
   if (!r->compressed)
@@ -756,7 +763,7 @@
 
   cups_raster_update(r);
 
-  return (1);
+  return (r->header.cupsBytesPerLine != 0 && r->header.cupsHeight != 0 && (r->header.cupsBytesPerLine % r->bpp) == 0);
 }
 
 

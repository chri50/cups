commit 74f437b7d20be44bacbbbc792da69ff9c82dfe8f
Author: Zdenek Dohnal <zdohnal@redhat.com>
Date:   Tue Jun 18 10:43:30 2024 +0200

    scheduler: Fix cupsd activated on-demand via socket
    
    If only the expected cups.sock is set as listener in cupsd.conf, the
    array Listeners was NULL. To prevent copying the code, do the array
    allocation earlier and have only one check for Listeners, in
    service_checkin() which is run every time cupsd starts.
    
    Fixes #985

Index: cups-2.4.2/scheduler/conf.c
===================================================================
--- cups-2.4.2.orig/scheduler/conf.c	2024-06-28 11:44:05.099633082 +0200
+++ cups-2.4.2/scheduler/conf.c	2024-06-28 11:44:05.095633082 +0200
@@ -558,6 +558,18 @@
 
   cupsdDeleteAllListeners();
 
+ /*
+  * Allocate array Listeners
+  */
+
+  Listeners = cupsArrayNew(NULL, NULL);
+
+  if (!Listeners)
+  {
+    fprintf(stderr, "Unable to allocate memory for array Listeners.");
+    return (0);
+  }
+
   old_remote_port = RemotePort;
   RemotePort      = 0;
 
@@ -1048,32 +1060,6 @@
   }
 
  /*
-  * Check that we have at least one listen/port line; if not, report this
-  * as an error and exit!
-  */
-
-#ifdef HAVE_ONDEMAND
-  if (cupsArrayCount(Listeners) == 0 && !OnDemand)
-#else
-  if (cupsArrayCount(Listeners) == 0)
-#endif // HAVE_ONDEMAND
-  {
-   /*
-    * No listeners!
-    */
-
-    cupsdLogMessage(CUPSD_LOG_EMERG,
-                    "No valid Listen or Port lines were found in the "
-		    "configuration file.");
-
-   /*
-    * Commit suicide...
-    */
-
-    cupsdEndProcess(getpid(), 0);
-  }
-
- /*
   * Set the default locale using the language and charset...
   */
 
@@ -3148,17 +3134,6 @@
         * Allocate another listener...
 	*/
 
-        if (!Listeners)
-	  Listeners = cupsArrayNew(NULL, NULL);
-
-	if (!Listeners)
-	{
-          cupsdLogMessage(CUPSD_LOG_ERROR,
-	                  "Unable to allocate %s at line %d - %s.",
-	                  line, linenum, strerror(errno));
-          break;
-	}
-
         if ((lis = calloc(1, sizeof(cupsd_listener_t))) == NULL)
 	{
           cupsdLogMessage(CUPSD_LOG_ERROR,
Index: cups-2.4.2/scheduler/main.c
===================================================================
--- cups-2.4.2.orig/scheduler/main.c	2024-06-28 11:44:05.099633082 +0200
+++ cups-2.4.2/scheduler/main.c	2024-06-28 11:45:15.471659573 +0200
@@ -2044,9 +2044,7 @@
     * No listeners!
     */
 
-    cupsdLogMessage(CUPSD_LOG_EMERG,
-                    "No valid Listen or Port lines were found in the "
-		    "configuration file.");
+    cupsdLogMessage(CUPSD_LOG_EMERG, "No listener sockets present.");
 
    /*
     * Commit suicide...

#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: Fix arbitrary code execution via incorrect code word handling
# Origin: upstream, r9865
# Bug: http://cups.org/str.php?L3914

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' cups-1.4.3~/filter/image-gif.c cups-1.4.3/filter/image-gif.c
--- cups-1.4.3~/filter/image-gif.c	2011-09-12 09:25:48.162346018 -0400
+++ cups-1.4.3/filter/image-gif.c	2011-09-12 09:25:52.382346047 -0400
@@ -648,11 +648,13 @@
 
     if (code == max_code)
     {
-      *sp++ = firstcode;
-      code  = oldcode;
+      if (sp < (stack + 8192))
+	*sp++ = firstcode;
+
+      code = oldcode;
     }
 
-    while (code >= clear_code)
+    while (code >= clear_code && sp < (stack + 8192))
     {
       *sp++ = table[1][code];
       if (code == table[0][code])
@@ -661,8 +663,10 @@
       code = table[0][code];
     }
 
-    *sp++ = firstcode = table[1][code];
-    code  = max_code;
+    if (sp < (stack + 8192))
+      *sp++ = firstcode = table[1][code];
+
+    code = max_code;
 
     if (code < 4096)
     {

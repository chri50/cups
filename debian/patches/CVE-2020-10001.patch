From efbea1742bd30f842fbbfb87a473e5c84f4162f9 Mon Sep 17 00:00:00 2001
From: Michael R Sweet <msweet@msweet.org>
Date: Mon, 1 Feb 2021 15:02:32 -0500
Subject: [PATCH] Fix a buffer (read) overflow in ippReadIO (CVE-2020-10001)

---
 CHANGES-OPENPRINTING.md | 2 ++
 cups/ipp.c              | 8 +++++---
 2 files changed, 7 insertions(+), 3 deletions(-)

#diff --git a/CHANGES-OPENPRINTING.md b/CHANGES-OPENPRINTING.md
#index e8f039695b..c9715c07ac 100644
#--- a/CHANGES-OPENPRINTING.md
#+++ b/CHANGES-OPENPRINTING.md
#@@ -4,6 +4,8 @@ OpenPrinting CUPS Changes
# Changes in CUPS v2.3.3op2
# -------------------------
# 
#+- Security: Fixed a buffer (read) overflow in the `ippReadIO` function
#+  (CVE-2020-10001)
# - Clarified the documentation for the "Listen" directive (Issue #53)
# - Fixed duplicate ColorModel entries for AirPrint printers (Issue 59)
# - Fixed directory/permission defaults for Debian kfreebsd-based systems
--- a/cups/ipp.c
+++ b/cups/ipp.c
@@ -3079,7 +3079,8 @@ ippReadIO(void       *src,		/* I - Data
   unsigned char		*buffer,	/* Data buffer */
 			string[IPP_MAX_TEXT],
 					/* Small string buffer */
-			*bufptr;	/* Pointer into buffer */
+			*bufptr,	/* Pointer into buffer */
+			*bufend;	/* End of buffer */
   ipp_attribute_t	*attr;		/* Current attribute */
   ipp_tag_t		tag;		/* Current tag */
   ipp_tag_t		value_tag;	/* Current value tag */
@@ -3640,6 +3641,7 @@ ippReadIO(void       *src,		/* I - Data
 		}
 
                 bufptr = buffer;
+                bufend = buffer + n;
 
 	       /*
 	        * text-with-language and name-with-language are composite
@@ -3653,7 +3655,7 @@ ippReadIO(void       *src,		/* I - Data
 
 		n = (bufptr[0] << 8) | bufptr[1];
 
-		if ((bufptr + 2 + n) >= (buffer + IPP_BUF_SIZE) || n >= (int)sizeof(string))
+		if ((bufptr + 2 + n + 2) > bufend || n >= (int)sizeof(string))
 		{
 		  _cupsSetError(IPP_STATUS_ERROR_INTERNAL,
 		                _("IPP language length overflows value."), 1);
@@ -3680,7 +3682,7 @@ ippReadIO(void       *src,		/* I - Data
                 bufptr += 2 + n;
 		n = (bufptr[0] << 8) | bufptr[1];
 
-		if ((bufptr + 2 + n) >= (buffer + IPP_BUF_SIZE))
+		if ((bufptr + 2 + n) > bufend)
 		{
 		  _cupsSetError(IPP_STATUS_ERROR_INTERNAL,
 		                _("IPP string length overflows value."), 1);

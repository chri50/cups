From 8c9b3606cca99e5dfc51784a9de1634345db7579 Mon Sep 17 00:00:00 2001
From: Michael R Sweet <michael.r.sweet@gmail.com>
Date: Fri, 13 Dec 2019 09:30:46 -0500
Subject: [PATCH] CVE-2019-2228: Fix ippSetValueTag validation of default
 language.

---
 CHANGES.md | 4 +++-
 cups/ipp.c | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

#diff --git a/CHANGES.md b/CHANGES.md
#index f8ce9f7f5..46bd6aa6a 100644
#--- a/CHANGES.md
#+++ b/CHANGES.md
#@@ -1,10 +1,12 @@
#-CHANGES - 2.2.13 - 2019-12-04
#+CHANGES - 2.2.13 - 2019-12-13
# =============================
# 
# 
# Changes in CUPS v2.2.13
# -----------------------
# 
#+- CVE-2019-2228: The `ippSetValuetag` function did not validate the default
#+  language value.
# - Added a workaround for the scheduler's systemd support (Issue #5640)
# - Fixed spelling of "fold-accordion".
# - Fixed the default common name for TLS certificates used by `ippserver`.
--- a/cups/ipp.c
+++ b/cups/ipp.c
@@ -4763,7 +4763,7 @@ ippSetValueTag(
           return (0);
 
         if (ipp->attrs && ipp->attrs->next && ipp->attrs->next->name &&
-            !strcmp(ipp->attrs->next->name, "attributes-natural-language"))
+            !strcmp(ipp->attrs->next->name, "attributes-natural-language") && (ipp->attrs->next->value_tag & IPP_TAG_CUPS_MASK) == IPP_TAG_LANGUAGE)
         {
          /*
           * Use the language code from the IPP message...
